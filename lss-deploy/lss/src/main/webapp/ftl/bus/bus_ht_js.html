

<script type="text/javascript">
	
        var baseAction = "<@sp.ctx />/user/bus/busHt.htm"
    	var addBaseAction = "<@sp.ctx />/user/bus/busHtAdd.htm"
    	var updateBaseAction = "<@sp.ctx />/user/bus/busHtUpdate.htm";
        var materialAction = "<@sp.ctx />/user/bus/busMaterial.htm"
        var repairAction="<@sp.ctx />/user/sys/repairInfo.htm";
        var customerAction = "<@sp.ctx />/user/sys/customerInfo.htm"
        
		function createNewTab(title,type) {
        	
			var a="${add!'0'}"
			var b="${upd!'0'}"
			var c="${del!'0'}"
			var d="${exp!'0'}"
			var e="${aud!'0'}"
			var role="&a="+a+"&b="+b+"&c="+c+"&d="+d+"&e="+e;
			switch (type) {
			case 0:
				window.parent.open1(title, baseAction+"?x="+Math.random()+role);
				break;
			case 1:
				window.parent.open1(title, addBaseAction+"?x="+Math.random()+role);
				window.parent.$('#tabs').tabs('close', '中心租赁合同管理');
				break;
            case 2:
            	var row = $('#dg').datagrid('getSelected');
    			if (row) {
    				window.parent.open1(title, updateBaseAction+"?id="+row.htcode+"&loginName="+row.loginName+role);
    				window.parent.$('#tabs').tabs('close', '中心租赁合同管理');
    			}
				break;
			}
			
		}
		
		function selectHtTab(title){
		    $('#ht_tab').tabs('select', title);
	    }
        function isCurrentTab(index){
        	var tab_ = $('#ht_tab').tabs('getSelected');
        	var index_ = $('#ht_tab').tabs('getTabIndex',tab_);
        	if(index==index_){
        		return true;
        	}
        	return false;
        }
        
        function closeForm(subtitle){
			if(confirm('确认要关闭吗？')){
				window.parent.$('#tabs').tabs('close', subtitle);
			}
			
		}
        $('#createtime').datetimebox({
        	onChange: function(newValue, oldValue)
        	{
                if(newValue!=oldValue)
                {
                	changeSetData(newValue);
                }
            }
        });
        $('#beginDate').datebox({
        	onChange: function(newValue, oldValue)
        	{
                if(newValue!=oldValue)
                {
                	changeSetData(newValue);
                }
            }
        });
        $('#endDate').datebox({
        	onChange: function(newValue, oldValue)
        	{
                if(newValue!=oldValue)
                {
                	changeSetData(newValue);
                }
            }
        });
        /**
         *改变文本时设置数据
         **/
        function changeSetData(newValue){
	        	var beginDate=$("#beginDate").datebox('getValue');
	        	var endDate=$("#endDate").datebox('getValue');
	        	if(beginDate==null || beginDate=="")
	        	{
	        		beginDate=newValue;
	        		$("#beginDate").datebox('setValue', beginDate);
	        	}
	        	if(endDate==null || endDate=="")
	        	{
	        		var myData=new Date(newValue);
	            	myData.setDate(myData.getDate()+365)
	            	endDate =myData.format("yyyy-MM-dd"); 
		        	$("#endDate").datebox('setValue', endDate);
	        	}
	        	
	        	var days=getTotalDays();
	        	$("#totalDays").numberbox('setValue', days);
        }
        function getTotalDays(){
	        	var beginDate=$("#beginDate").datebox('getValue');
	        	var endDate=$("#endDate").datebox('getValue');
	            return dateDiff(beginDate,endDate);
        }
        function dateDiff(sDate1, sDate2)
        {
            var aDate, oDate1, oDate2, iDays
            aDate = sDate1.split("-")
            oDate1 = new Date(aDate[0] + '-' + aDate[1] + '-' + aDate[2]) //转换为12-18-2002格式
            aDate = sDate2.split("-")
            oDate2 = new Date(aDate[0] + '-' + aDate[1] + '-' + aDate[2])
            //iDays = parseInt(Math.abs(oDate1 - oDate2) / 1000 / 60 / 60 /24) //把相差的毫秒数转为天数
            iDays = parseInt((oDate2 - oDate1) / 1000 / 60 / 60 /24) //把相差的毫秒数转为天数
            return iDays
        }


		function destroyDg() {
			var row = $('#dg').datagrid('getSelected');
			if (row) {
				$.messager.confirm('确定删除', '确定删除选中数据吗?', function(r) {
					if (r) {
						$.post(baseAction + '?method=remove', {
							id : row.htcode
						}, function(result) {
							if (result.success) {
								$('#dg').datagrid('reload'); // reload the user data
							} else {
								$.messager.alert('失败提示', result.errorMsg);
							}
						}, 'json');
					}
				});
			}
		}
		
		//详情查看 
		var dg_views_init = false;
	 	var dg_titles_arr  ;
	 	var dg_props_arr  ;
	 	function initDgView(){
	 		dg_titles_arr = [];
	 		dg_props_arr = [];
	 		var props = $("th","#dg");
	 		for(var i=0;i<props.length;i++){
	 			dg_props_arr.push($(props[i]).attr("field"));
	 			dg_titles_arr.push($(props[i]).text());
	 		}
	 		dg_views_init = true;
	 	}
		
	 	
		function comm_view(title,audit){
				var row = $('#dg').datagrid('getSelected');
				if (!row) {
					return;
				}
				if(! dg_views_init){
					initDgView();	
				}
				
				$('#view-dlg').dialog('open').dialog('setTitle',title);
				var newHtml = "";
				for(var i=0;i<dg_props_arr.length;i++){
					var ti = dg_titles_arr[i];
					var va = row[dg_props_arr[i]];
					if(!va && va!=0){
						va = "&nbsp;"
					}
					var sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;" ;
					if(i%2 == 0){
						sty += "background-color:#F0F0F0;";
					}else{
						sty += "background-color:#ECF5FF;";
					}
					
                    var propertyId=dg_props_arr[i];
 					var dataId
 					if(propertyId=="htcode")
 					{
 						dataId=va;
 						$("#hide_id").val(va);
 					}
 					if(propertyId=="status"){
			    		selectStatus=va;
			    		va = formatStatus(va,'')
			    	}
			    	if(propertyId=="comType"){
			    		va = formatComType(va,'')
			    	}
			    	if(propertyId=="htType"){
			    		va = formatHtType(va,'')
			    	}
					    	
			        //文本显示
					newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
					
					
				}
				$('#view-dlg-content').html(newHtml);
				
				var openStatus=1; //是初始状态
 				if(selectStatus!=openStatus){
 					 $("#btn_view_ok").hide();
 					 $("#btn_view_no").hide();
 				}
				
				//获取明细
				loadDetailData(dataId);
			
		}
		function viewDetail_(){
				$("#btn_view_ok").hide();
				$("#btn_view_no").hide();
				comm_view('详情',false);
		}
		function auditDg(){
				$("#btn_view_ok").show();
				$("#btn_view_no").show();
				comm_view('审核',true);
			
		}
		var dataPara={
        		id:'',
        		status:'',
        }
        function saveAudit(status){
        	var hideId=$("#hide_id").val();
        	dataPara.status=status;
        	dataPara.id=hideId;
        	url = updateBaseAction+'?method=auditInfo';
        	$.ajax({
				url: url,
				type: 'POST',
				data:dataPara,
				dataType: 'json',
				//timeout: 1000,
				error: function(){
					$.messager.alert('失败提示', '提交数据失败，请联系管理员。');
				},
				success: function(result){
					
					if (result.success) {
						 $('#view-dlg').dialog('close'); // close the dialog
	    				 $('#dg').datagrid('reload'); // reload the user data
					} else {
						$.messager.alert('失败提示', result.errorMsg);
					}
					
				}
			});
        }
		function showMsg(newVal,oldVal)
        {
			
	        	 var htType=$("#htType").val();
		         if(htType==newVal)
		         {
		        	 $("#span_msg").html(" 租出-针对租赁公司与工地之间");
		         }else{
		        	 $("#span_msg").html(" 转租-针对租赁公司与租赁公司之间");
		         }
        }
        showMsg($("#htType").val(),'');
		function formatComType(val, row) {
			var vResult = "";
			if (val == '1') {
				vResult = '<span style="color:green;">内部</span>';
			} else if (val == '2') {
				vResult = '<span style="color:green;">外部</span>';
			} else if (val == '3') {
				vResult = '<span style="color:green;">大客户</span>';
			}
			return vResult;
		}
		function formatHtType(val, row) {
			var vResult = "";
			if (val == '1') {
				vResult = '<span style="color:green;">转租</span>';
			} else if (val == '2') {
				vResult = '<span style="color:green;">租出</span>';
			}
			return vResult;
		}
		function formatStatus(val, row) {
			var vResult = "";
			if (val == '0') {
				vResult = '<span style="color:green;">正常</span>';
			} else if (val == '1') {
				vResult = '<span style="color:dodgerblue;">审核中</span>';
			} else if (val == '2') {
				vResult = '<span style="color:red;">审核未通过</span>';
			} else if (val == '9') {
				vResult = '<span style="color:gray;">合同作废</span>';
			}
			return vResult;
		}
		
		/**
		 * 格式化费用归属
		 **/
		function formatFeeBelong(val, row) {
			var vResult = "";
			if (val == '1') {
				vResult = '<span style="color:green;">乙方出，甲方不代收</span>';
			} else if (val == '2') {
				vResult = '<span style="color:green;">乙方出，甲方代收</span>';
			} else if (val == '3') {
				vResult = '<span style="color:green;">甲方出</span>';
			}
			return vResult;
		}
		/**
		 * 格式化结算方式
		 **/
		function formatSettlementType(val, row) {
			var vResult = "";
			if (val == '1') {
				vResult = '<span style="color:green;">算头不算尾</span>';
			} else if (val == '2') {
				vResult = '<span style="color:green;">算尾不算头</span>';
			} else if (val == '3') {
				vResult = '<span style="color:green;">算头算尾</span>';
			} else if (val == '4') {
				vResult = '<span style="color:green;">头尾都不算</span>';
			}
			return vResult;
		}
		
		var materialList=[]
		var materialListDown=[]
		/**
		 *初始化物质信息
		 **/
		function initMaterial(){
			var dataUrl=materialAction+'?method=getMaterialType';
			$.post(dataUrl,{},
			    function(msg){
				materialList=eval("("+msg+")");
				initDgItem()
			 })
			dataUrl=repairAction+'?method=getRepairInfo'
			$.post(dataUrl,{},
				function(msg){
				materialListDown=eval("("+msg+")");
				initDgItemDown()
			})
		}
		
		/**
		 *初始化租费列表
		 **/
		function initDgItem(){
			var loadUrl="";
			<#if htcode??>
			loadUrl=baseAction+'?method=getHtRentinfoList'+"&id="+"${htcode!''}";
			</#if>
        	$('#dgItem').datagrid({
        		url:loadUrl,
        	    ctrlSelect:true,
        	    columns:[[
        	        {field:'typeid',title:'物资名称',width:150,align:'left',
						formatter:function(value,row){
							return row.name;
						},
						editor:{
							type:'combogrid',
							options:{
								idField:'typeid',
								textField:'name',
								data:materialList,
								required:true,
								onClickRow:onClickRowChangeVal,
								columns:[[    
							                {field:'name',title:'物资名称',width:60},    
							                {field:'accountFlag',title:'单位',width:100}
							            ]],
							    loadFilter: function(data){
							        		
							        		var dataNew=[]
							        		for ( var i = 0; i < data.length; i++) {
							        			if(data[i].parentid!="0" && data[i].status!="9"){
							        				dataNew.push(data[i]);
							        			}
											}
							    return dataNew;
							    }

							}
						}},  
        	        {field:'rentalDay',title:'日租金',width:100,align:'left',editor:{type:'numberbox',options:{precision:4,required:true}}},
        	        {field:'quantity',title:'约租量',width:100,align:'left',editor:{type:'numberbox',options:{required:true}}},
        	        {field:'tonQantity',title:'每吨数量',width:100,align:'left',editor:{type:'numberbox',options:{required:true}}},
        	        {field:'unit',title:'单位',width:100,align:'left'},
        	        {field:'materialcode',title:'隐藏的code',hidden:true},
        	    ]]    
        	}); 

		}
		/**
		 *初始化维修费列表
		 **/
        function initDgItemDown(){
        	var loadUrl="";
			<#if htcode??>
			loadUrl=baseAction+'?method=getHtRepairinfoList'+"&id="+"${htcode!''}";
			</#if>
        	$('#dgItemDown').datagrid({
        		url:loadUrl,
        	    ctrlSelect:true,
        	    columns:[[
        	        {field:'id',title:'物资名称',width:150,align:'left',
						formatter:function(value,row){
							return row.tName;
						},
						editor:{
							type:'combogrid',
							width:1000,
							options:{
								idField:'id',
								textField:'tName',
								data:materialListDown,
								required:true,
								onClickRow:onClickDownRowChangeVal,
								columns:[[    
							                {field:'tName',title:'物资名称',width:100},
							                {field:'name',title:'维修项目',width:100},   
							                {field:'feeUnit',title:'单位',width:100}
							            ]]    
							}
						}},  
        	        {field:'name',title:'收费类型',width:120,align:'left'},
        	        {field:'price',title:'单价',width:120,align:'left',editor:{type:'numberbox',options:{precision:4,required:true}}},
        	        {field:'unit',title:'单位',width:120,align:'left'},
        	    ]],
//                 loadFilter: function(data){
	        		
	        		
// 	        		return data;
// 	        	}
        	});  

		}
		
        /**
		 *加载维修费用
		 **/
        function loadRepairInfo(dataId){
        	
			
        	var dataUrl=baseAction+'?method=getRepairInfo&id='+dataId
        			
        	$('#dgItemDown').datagrid({
        	    url:dataUrl,    
        	    ctrlSelect:true,
        	    columns:[[
        	        {field:'id',title:'物资名称',width:150,align:'left',
						formatter:function(value,row){
							return row.tName;
						},
						editor:{
							type:'combogrid',
							width:1000,
							options:{
								idField:'id',
								textField:'tName',
								data:materialListDown,
								required:true,
								onClickRow:onClickDownRowChangeVal,
								columns:[[    
								            {field:'tName',title:'物资名称',width:100},
							                {field:'name',title:'维修项目',width:100},   
							                {field:'feeUnit',title:'单位',width:100}
							            ]]
							   
							}
						}},
        	        {field:'name',title:'收费类型',width:120,align:'left'},
        	        {field:'price',title:'单价',width:120,align:'left',editor:{type:'numberbox',options:{precision:4,required:true}}},
        	        {field:'unit',title:'单位',width:120,align:'left'},
        	        {field:'materialcode',title:'隐藏的物资编码',hidden:true},
        	        {field:'typeid',title:'隐藏的物资类型id',hidden:true},
        	        {field:'repairId',title:'隐藏维修类型id',hidden:true},
        	    ]],
                loadFilter: function(data){
	        		
	        		var dataOld = $('#dgItemDown').datagrid('getRows');
	        		
	        		for ( var i = 0; i < data.length; i++) {
	        			dataOld.push(data[i]);
					}
	        		return dataOld;
	        	}

        	});  
        	editIndexDown = undefined;  //一定要加
           
		}
		
		/**
		 *点击租费选项，数据改变
		 **/
        function onClickRowChangeVal(index,row){
        	
            var rowData=$('#dgItem').datagrid('getSelected');
            
            rowData.materialcode=row.typeid
            rowData.unit=row.accountFlag
			acceptUp()  //保存数据
			//当前选中行索引
			editIndex = $('#dgItem').datagrid('getRowIndex',rowData);
            //选中当前行打开编辑
			$('#dgItem').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
            
			if(!checkDataExist())
        	loadRepairInfo(row.typeid)
		}
        /**
         *当前物资的维修费是否存在
         **/
		function checkDataExist(){
			var row=$('#dgItem').datagrid('getSelected');
			var rows=$('#dgItemDown').datagrid('getRows')
			for ( var i = 0; i < rows.length; i++) {
				if(row.typeid==rows[i].typeid){
					return true;
				}
			}
			return false;
		}
		 /**
		 *校验提交参数
		 **/
	    function checkSubmitParam(){
	    	var tabIndex=0; //工程资料
	    	var createtime=$("#createtime");
	    	var createtimeVal=createtime.datetimebox('getValue');
	    	var beginDate=$("#beginDate");
	    	var beginDateVal=beginDate.datebox('getValue');
	    	var endDate=$("#endDate");
	    	var endDateVal=endDate.datebox('getValue');
	    	var htType=$("#htType");
	    	var htTypeVal=htType.datebox('getValue');
	    	
	    	var comNameObj=$("#comName");
	    	var comAddress=$("#comAddress");
	    	var comLinkman=$("#comLinkman");
	    	var comTel=$("#comTel");
	    	var comType=$("#comType");
	    	var comTypeVal=comType.combobox('getValue');
	    	var projectName=$("#projectName");
	    	var projectDeposit=$("#projectDeposit");
	    	var projectAdress=$("#projectAdress");
	    	var totalDays=$("#totalDays");
		    if(!isCurrentTab(0)){
			    	
			    	if(createtimeVal==""){
						$.messager.alert('提示信息', '签订日期不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							createtime.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(beginDateVal==""){
						$.messager.alert('提示信息', '项目开始日期不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							beginDate.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(endDateVal==""){
						$.messager.alert('提示信息', '项目结束日期不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							endDate.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(projectName.val()==""){
						$.messager.alert('提示信息', '项目名称不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							projectName.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(projectAdress.val()==""){
						$.messager.alert('提示信息', '项目地址不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							projectAdress.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(projectDeposit.val()==""){
						$.messager.alert('提示信息', '项目保证金不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							projectDeposit.textbox('textbox').focus();	
						});
						return false;
					}
					if(comNameObj.val()==""){
						$.messager.alert('提示信息', '公司名称不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							comNameObj.textbox('textbox').focus();	
						});
						return false;
					}
					if(comAddress.val()==""){
						$.messager.alert('提示信息', '公司地址不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							comAddress.textbox('textbox').focus();	
						});
						return false;
					}
					if(comLinkman.val()==""){
						$.messager.alert('提示信息', '公司联系人不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							comLinkman.textbox('textbox').focus();	
						});
						return false;
					}
					if(comTel.val()==""){
						$.messager.alert('提示信息', '联系方式不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							comTel.textbox('textbox').focus();	
						});
						return false;
					}
					if(comTypeVal==""){
						$.messager.alert('提示信息', '公司类型不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							comType.textbox('textbox').focus();	
						});
						return false;
					}
					if(totalDays.val()==""){
						$.messager.alert('提示信息', '合计租期不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							totalDays.textbox('textbox').focus();	
						});
						return false;
					}
					if(htTypeVal==""){
						$.messager.alert('提示信息', '合同类型不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							htType.textbox('textbox').focus();	
						});
						return false;
					}
		    }else{
			    	if(createtimeVal==""){
						return false;
					}
			    	if(beginDateVal==""){
						return false;
					}
			    	if(endDateVal==""){
						return false;
					}
			    	if(projectName.val()==""){
						return false;
					}
					if(projectAdress.val()==""){
						return false;
					}
			    	if(projectDeposit.val()==""){
						return false;
					}
					if(comNameObj.val()==""){
						return false;
					}
					if(comAddress.val()==""){
						return false;
					}
					if(comLinkman.val()==""){
						return false;
					}
					if(comTel.val()==""){
						return false;
					}
					if(comTypeVal==""){
						return false;
					}
					if(totalDays.val()==""){
						return false;
					}
					if(htTypeVal==""){
						return false;
					}
		    }
		    
		    tabIndex=1; //杂费
		    var getonFee=$("#getonFee");
	    	var getoffFee=$("#getoffFee");
	    	var transportFee=$("#transportFee");
	    	var deposit=$("#deposit");
	    	var lateFee=$("#lateFee");
	    	var bagFee=$("#bagFee");
	    	var lateBegdate=$("#lateBegdate");
	    	var zxfeeBelong=$("#zxfeeBelong");
	    	var zxfeeBelongVal=zxfeeBelong.combobox('getValue');
	    	var transportfeeBelong=$("#transportfeeBelong");
	    	var transportfeeBelongVal=transportfeeBelong.combobox('getValue');
	    	var otherfeeBelong=$("#otherfeeBelong");
	    	var otherfeeBelongVal=otherfeeBelong.combobox('getValue');
	    	var settlementType=$("#settlementType");
	    	var settlementTypeVal=settlementType.combobox('getValue');
		    if(!isCurrentTab(tabIndex)){
			    	
			    	if(getonFee.val()==""){
						$.messager.alert('提示信息', '上车费不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							getonFee.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(getoffFee.val()==""){
						$.messager.alert('提示信息', '下车费不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							getoffFee.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(transportFee.val()==""){
						$.messager.alert('提示信息', '运输费不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							transportFee.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(deposit.val()==""){
						$.messager.alert('提示信息', '押金不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							deposit.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(lateFee.val()==""){
						$.messager.alert('提示信息', '滞纳金不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							lateFee.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(bagFee.val()==""){
						$.messager.alert('提示信息', '袋费不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							bagFee.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(lateBegdate.val()==""){
						$.messager.alert('提示信息', '滞纳金开起日期不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							lateBegdate.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(zxfeeBelongVal==""){
						$.messager.alert('提示信息', '装卸费归属不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							zxfeeBelong.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(transportfeeBelongVal==""){
						$.messager.alert('提示信息', '运费归属不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							transportfeeBelong.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(otherfeeBelongVal==""){
						$.messager.alert('提示信息', '杂费归属不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							otherfeeBelong.textbox('textbox').focus();	
						});
						return false;
					}
			    	if(settlementTypeVal==""){
						$.messager.alert('提示信息', '结算方式不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							settlementType.textbox('textbox').focus();	
						});
						return false;
					}
			    	
	        }else{
		        	if(getonFee.val()==""){
						return false;
					}
			    	if(getoffFee.val()==""){
						return false;
					}
			    	if(transportFee.val()==""){
						return false;
					}
			    	if(deposit.val()==""){
						return false;
					}
			    	if(lateFee.val()==""){
						return false;
					}
			    	if(bagFee.val()==""){
						return false;
					}
			    	if(lateBegdate.val()==""){
						return false;
					}
			    	if(zxfeeBelongVal==""){
						return false;
					}
			    	if(transportfeeBelongVal==""){
						return false;
					}
			    	if(otherfeeBelongVal==""){
						return false;
					}
			    	if(settlementTypeVal==""){
						return false;
					}
	        }
		    
		    tabIndex=2;//租修赔偿标准
		    if(!isCurrentTab(tabIndex))
		    {
			    	var rows = $('#dgItem').datagrid('getRows');
				    
				    for (var i = 0; i < rows.length; i++) {
						if(rows[i].rentalDay=="undefined" || rows[i].rentalDay==null  || rows[i].rentalDay=='' ){
							$.messager.alert('提示', "请输入日租金并保存");
							selectHtTab(tabIndex);
							return false;
						}
						if(rows[i].quantity=="undefined" || rows[i].quantity==null  || rows[i].quantity=='' ){
							$.messager.alert('提示', "请输入约租量并保存");
							selectHtTab(tabIndex);
							return false;
						}
						if(rows[i].tonQantity=="undefined" || rows[i].tonQantity==null  || rows[i].tonQantity=='' ){
							$.messager.alert('提示', "请输入每吨数量并保存");
							selectHtTab(tabIndex);
							return false;
						}
					}
				   
				    var rows2 = $('#dgItemDown').datagrid('getRows');
				    for (var i = 0; i < rows2.length; i++) {
						if(rows2[i].price=="undefined" || rows2[i].price==null  || rows2[i].price=='' ){
							$.messager.alert('提示', "请输入单价并保存");
							selectHtTab(tabIndex);
							return false;
						}
					}
		    }else{
			    	var rows = $('#dgItem').datagrid('getRows');
				    
				    for (var i = 0; i < rows.length; i++) {
						if(rows[i].rentalDay=="undefined" || rows[i].rentalDay==null  || rows[i].rentalDay=='' ){
							selectHtTab(tabIndex);
							return false;
						}
						if(rows[i].quantity=="undefined" || rows[i].quantity==null  || rows[i].quantity=='' ){
							selectHtTab(tabIndex);
							return false;
						}
						if(rows[i].tonQantity=="undefined" || rows[i].tonQantity==null  || rows[i].tonQantity=='' ){
							selectHtTab(tabIndex);
							return false;
						}
					}
				   
				    var rows2 = $('#dgItemDown').datagrid('getRows');
				    for (var i = 0; i < rows2.length; i++) {
						if(rows2[i].price=="undefined" || rows2[i].price==null  || rows2[i].price=='' ){
							selectHtTab(tabIndex);
							return false;
						}
					}
		    }
		    
		    var fromCustomerCode=$("#fromCustomerCode");
	    	var fromCustomerCodeVal=fromCustomerCode.combobox('getValue');
		    tabIndex=3;//承租公司
		    if(!isCurrentTab(tabIndex))
		    {
			    	if(fromCustomerCodeVal==""){
						$.messager.alert('提示信息', '承租单位不能为空！','info' ,function () {
							selectHtTab(tabIndex);
							fromCustomerCode.textbox('textbox').focus();	
						});
						return false;
					}
		    }else{
			    	if(fromCustomerCodeVal==""){
						return false;
					}
		    }
		    
// 		    var assureCustomerCode=$("#assureCustomerCode");
// 	    	var assureCustomerCodeVal=assureCustomerCode.combobox('getValue');
// 		    tabIndex=4;//担保公司
// 		    if(!isCurrentTab(tabIndex))
// 		    {
// 			    	if(assureCustomerCodeVal==""){
// 						$.messager.alert('提示信息', '担保单位不能为空！','info' ,function () {
// 							selectHtTab(tabIndex);
// 							assureCustomerCode.textbox('textbox').focus();	
// 						});
// 						return false;
// 					}
// 		    }else{
// 			    	if(assureCustomerCodeVal==""){
// 						return false;
// 					}
// 		    }
		    
		    return true;
	    }
        /**
         *点击维修费的选择项
         **/
		function onClickDownRowChangeVal(index,row){
			
			var rowOld=$('#dgItemDown').datagrid('getSelected');
			
			rowOld.typeid=row.typeid
			rowOld.materialcode=row.typeid
			rowOld.name=row.name
			rowOld.tName=row.tName
			rowOld.unit=row.feeUnit
			rowOld.repairId=row.id
			acceptDown()
			//当前选中行索引
			editIndexDown = $('#dgItemDown').datagrid('getRowIndex',rowOld);
            //选中当前行打开编辑
			$('#dgItemDown').datagrid('selectRow', editIndexDown).datagrid('beginEdit', editIndexDown);
		}
        
		//加载明细
        function loadDetailData(dataId){
        	
        	var detailUrl=baseAction+'?method=getHtRentinfoList&id='+dataId
        	
        	$('#dgItem_detail').datagrid({    
        	    url:detailUrl,    
        	    ctrlSelect:true,
        	    columns:[[
        	        {field:'name',title:'物资名称',width:150,align:'left'}, 
        	        {field:'rentalDay',title:'日租费',width:100,align:'left'},
        	        {field:'quantity',title:'约租量',width:100,align:'left'},
        	        {field:'tonQantity',title:'每吨数量',width:100,align:'left'},
        	        {field:'unit',title:'单位',width:100,align:'left'},
        	    ]]    
        	});  
        	
            detailUrl=baseAction+'?method=getHtRepairinfoList&id='+dataId
        	
        	$('#dgItemDown_detail').datagrid({
        	    url:detailUrl,    
        	    ctrlSelect:true,
        	    columns:[[
        	        {field:'tName',title:'物资名称',width:150,align:'left'},
        	        {field:'name',title:'收费类型',width:150,align:'left'},  
        	        {field:'price',title:'单价',width:100,align:'left'},
        	        {field:'unit',title:'单位',width:100,align:'left'},
        	    ]]    
        	});  
            
            getSettlementData(dataId);

        }
        $('#fromCustomerCode').combogrid({
			panelWidth:400,
	        url: customerAction + '?method=getCustomerList',
	        idField: 'cuscode',
	        textField: 'cusname',
	        columns: [[
	            {field: 'cuscode', title: '客户编号', width: 100},
	            {field: 'cusname', title: '单位名称', width: 100},
	            {field: 'linkman', title: '联系人', width: 100},
	            {field: 'custel', title: '电话', width: 100},
	            {field: 'cusaddress', title: '单位地址', width: 100},
	            {field: 'bankinfo', title: '开户银行', width: 100},
	            {field: 'accountno', title: '账号', width: 100},
	        ]],
	        mode: 'local',
	        onClickRow:onClickRowCustomerVal,
	        filter: function (q, row) {
	            var opts = $(this).combogrid('options');
	            // 过滤拼音码，转换大写字母
	            if (row.pyCode.indexOf(q.toUpperCase()) >= 0) {
	                return row.pyCode.indexOf(q.toUpperCase()) >= 0;
	            }
	            // 过滤中文名称
	            if (row[opts.textField].indexOf(q) >= 0) {
	                return row[opts.textField].indexOf(q) >= 0;
	            }
	        },
			loadFilter: function(data){
        		
        		var dataNew=[]
        		
        		for ( var i = 0; i < data.length; i++) {
        			if(data[i].custype==5){
        				dataNew.push(data[i]);
        			}
				}
        		return dataNew;
        	}
	    });
		
		$('#assureCustomerCode').combogrid({
			panelWidth:400,
	        url: customerAction + '?method=getCustomerList',
	        idField: 'cuscode',
	        textField: 'cusname',
	        columns: [[
	            {field: 'cuscode', title: '客户编号', width: 100},
	            {field: 'cusname', title: '单位名称', width: 100},
	            {field: 'linkman', title: '联系人', width: 100},
	            {field: 'custel', title: '电话', width: 100},
	            {field: 'cusaddress', title: '单位地址', width: 100},
	            {field: 'bankinfo', title: '开户银行', width: 100},
	            {field: 'accountno', title: '账号', width: 100},
	        ]],
	        mode: 'local',
	        onClickRow:onClickRowAssureVal,
	        filter: function (q, row) {
	            var opts = $(this).combogrid('options');
	            // 过滤拼音码，转换大写字母
	            if (row.pyCode.indexOf(q.toUpperCase()) >= 0) {
	                return row.pyCode.indexOf(q.toUpperCase()) >= 0;
	            }
	            // 过滤中文名称
	            if (row[opts.textField].indexOf(q) >= 0) {
	                return row[opts.textField].indexOf(q) >= 0;
	            }
	        },
			loadFilter: function(data){
        		
        		var dataNew=[]
        		
        		for ( var i = 0; i < data.length; i++) {
        			if(data[i].custype==4){
        				dataNew.push(data[i]);
        			}
				}
        		return dataNew;
        	}
	    });
		/**
		 *点击承租公司,信息设置
		 **/
		function onClickRowCustomerVal(index,row){
				$("#linkman").textbox('setValue',row.linkman)
	    	    $("#custel").textbox('setValue',row.custel)
	    	    $("#cusaddress").textbox('setValue',row.cusaddress)
	    	    $("#bankinfo").textbox('setValue',row.bankinfo)
	    	    $("#accountno").textbox('setValue',row.accountno)
		}
		/**
		 *点击担保公司,信息设置
		 **/
	    function onClickRowAssureVal(index,row){
	    	    $("#assureLinkman").textbox('setValue',row.linkman)
	    	    $("#assureCustel").textbox('setValue',row.custel)
	    	    $("#assureCusaddress").textbox('setValue',row.cusaddress)
	    	    $("#assureBankinfo").textbox('setValue',row.bankinfo)
	    	    $("#assureAccountno").textbox('setValue',row.accountno)
	    }
		/**获取结算数据**/
		function getSettlementData(dataId){
			
			var dataUrl=baseAction+'?method=getHtSettlementData&id='+dataId
			$.post(dataUrl,{},function(msg){
				
				var data=eval("("+msg+")");
				var newHtml=""
				
				ti="上车费"
				va=data.getonFee;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="下车费"
				va=data.getoffFee;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#ECF5FF;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="运输费"
				va=data.transportFee;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="押金"
				va=data.deposit;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#ECF5FF;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="滞纳金"
				va=data.lateFee;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="袋费"
				va=data.bagFee;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#ECF5FF;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				
				ti="滞纳金开起日期"
				va=data.lateBegdate;
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="装卸费归属"
				va=formatFeeBelong(data.zxfeeBelong,'');
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#ECF5FF;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				
				ti="运费归属"
				va=formatFeeBelong(data.transportfeeBelong,'');
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="杂费归属"
				va=formatFeeBelong(data.otherfeeBelong,'');
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#ECF5FF;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				ti="结算方式"
				va=formatSettlementType(data.settlementType,'');
				sty = "border-bottom: solid 1px #fff;padding: 4px;margin:0px;background-color:#F0F0F0;"
				newHtml+="<div class=\"fitem\" style=\""+sty+"\"><label style=\"width: 100px;text-align:right\">"+ti+":</label> <label style=\"width: 200px;\">"+va+"</label></div>"
				
				$("#view-dlg-settlement").html(newHtml);
			
			})
			
			
		}
		
        function loadFilterData(data){
    		
	    	var dataList={
	    			rows:[],
	    			footer:[]
	    	}
	    	dataList.rows=data;
			
			var typeMap={};  
	        var len = data.length;  
	        for(var i=0;i<len;i++){
		            if(typeMap[data[i].typeId] == undefined){
		                var list = [];  
		                list.push(data[i]);  
		                typeMap[data[i].typeId] = list;  
		            }else{  
		            	typeMap[data[i].typeId].push(data[i]);
		            }  
	        }
	        
	        var tj=0;
	        for(var typeId in typeMap){
		            var obj = typeMap[typeId];
		            var totalS=0;
		            var totalA=0;
		            footers={"materialcode":"合计","name":""}
		            for(var i = 0;i < obj.length;i++){
		            	var num=parseFloat(obj[i].quantity);
		            	if(!isNaN(num)){
		            		totalS+=num*parseFloat(obj[i].covertRatio);
		            	}
		            	totalA+=obj[i].totalAmt;
		            }
	            	if(tj>0){
	            		footers.materialcode="";
	            	}
	            	tj++;
		            footers.name=obj[0].fname+": "+totalS.toFixed(2)+""+obj[0].accountFlag;
		            dataList.footer.push(footers)
	        }
	    	return  dataList;
		}
		
        function loadData(){
	   		
	   	    var data = $('#dgItem').datagrid('getRows');
	   	     
	   	    var dataList={
	    			rows:[],
	    			footer:[]
	    	}
	   	    
	    	dataList.rows=data;
			
			var typeMap={};  
	        var len = data.length;  
	        for(var i=0;i<len;i++){
		            if(typeMap[data[i].typeId] == undefined){
		                var list = [];  
		                list.push(data[i]);  
		                typeMap[data[i].typeId] = list;  
		            }else{  
		            	typeMap[data[i].typeId].push(data[i]);
		            }  
	        }
	       
	        var tj=0;
	        for(var typeId in typeMap){
		            var obj = typeMap[typeId];
		            var totalS=0;
		            var totalA=0;
		            footers={"itemid":"合计","materialcode":""}
		            for(var i = 0;i < obj.length;i++){
		            	var num=parseFloat(obj[i].quantity);
		            	if(!isNaN(num)){
		            		totalS+=num*parseFloat(obj[i].covertRatio);
		            	}
		            	totalA+=obj[i].totalAmt;
		            }
	            	if(tj>0){
	            		footers.itemid="";
	            	}
	            	tj++;
		            footers.materialcode=obj[0].fname+": "+totalS.toFixed(2)+""+obj[0].accountFlag;
		            dataList.footer.push(footers)
		           
	        }  
	   		$('#dgItem').datagrid('loadData', dataList);
	   	}
		
		var editIndex = undefined;
		function endEditing(){
			if (editIndex == undefined){return true}
			if ($('#dgItem').datagrid('validateRow', editIndex)){
				var ed = $('#dgItem').datagrid('getEditor', {index:editIndex,field:'typeid'});
				var name = $(ed.target).combobox('getText');
				$('#dgItem').datagrid('getRows')[editIndex]['name'] = name;
				$('#dgItem').datagrid('endEdit', editIndex);
				editIndex = undefined;
				return true;
			} else {
				return false;
			}
		}
		// 点击编辑行
		function onClickCell(index, field){
			if (endEditing()){
				$('#dgItem').datagrid('selectRow', index).datagrid('beginEdit', index);
				var ed = $('#dgItem').datagrid('getEditor', {index:index,field:field});
				if (ed){
					($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
				}
				editIndex = index;
			} else {
				setTimeout(function(){
					$('#dgItem').datagrid('selectRow', editIndex);
				},0);
			}
		}
		var editIndexDown = undefined;
		function endEditingDown(){
			if (editIndexDown == undefined){return true}
			if ($('#dgItemDown').datagrid('validateRow', editIndexDown)){
				var ed = $('#dgItemDown').datagrid('getEditor', {index:editIndexDown,field:'id'});
				var name = $(ed.target).combobox('getText');
				$('#dgItemDown').datagrid('getRows')[editIndexDown]['tName'] = name;
				$('#dgItemDown').datagrid('endEdit', editIndexDown);
				editIndexDown = undefined;
				return true;
			} else {
				return false;
			}
		}
		// 点击编辑行
		function onClickCellDown(index, field){
			if (endEditingDown()){
				$('#dgItemDown').datagrid('selectRow', index).datagrid('beginEdit', index);
				var ed = $('#dgItemDown').datagrid('getEditor', {index:index,field:field});
				if (ed){
					($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
				}
				editIndexDown = index;
			} else {
				setTimeout(function(){
					$('#dgItemDown').datagrid('selectRow', editIndexDown);
				},0);
			}
		}
		
		function setEditing(rowIndex){
			
			var editors = $('#dgItem').datagrid('getEditors', rowIndex);
			
			var nameEditor = editors[1];
			
			nameEditor.target.bind('change', function(){
				alert('1')
			});
			nameEditor.target.bind('blur', function(){
				alert('2')
			});
			
		}
		
		/**
		 *租费费修改后保存表格数据 （界面上保存）
		 **/
		function acceptUp(){
			if (endEditing()){
				$('#dgItem').datagrid('acceptChanges');
			}
		}
		/**
		 *维修费修改后保存表格数据 （界面上保存）
		 **/
		function acceptDown(){
			if (endEditingDown()){
				$('#dgItemDown').datagrid('acceptChanges');
			}
		}
		//添加
		function appendUp(){
			if (endEditing()){
				$('#dgItem').datagrid('appendRow',{
					                                "rentalDay":1,
					                                "quantity":1000,
					                                "tonQantity":0});
				editIndex = $('#dgItem').datagrid('getRows').length -1;
				$('#dgItem').datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
		    }
		}
		function appendDown(){
			if (endEditingDown()){
				$('#dgItemDown').datagrid('appendRow',{});
				editIndexDown = $('#dgItemDown').datagrid('getRows').length -1;
				$('#dgItemDown').datagrid('selectRow', editIndexDown).datagrid('beginEdit', editIndexDown);
		    }
		}
		//移除
		function removeUp(){
			if (editIndex == undefined){return}
			removeJoinData();
			$('#dgItem').datagrid('cancelEdit', editIndex).datagrid('deleteRow', editIndex);
			editIndex = undefined; 
			acceptUp();
			
		}
		function removeDown(){
			if (editIndexDown == undefined){return}
			$('#dgItemDown').datagrid('cancelEdit', editIndexDown).datagrid('deleteRow', editIndexDown);
			editIndexDown = undefined;
		}
		//删除下面关联数据
		function removeJoinData(){
			var row=$('#dgItem').datagrid('getSelected')
			recursionDel(row);
			//删除数据后自动保存界面修改数据
			acceptDown();
		}
		//由于删除一条数据后索引会变化,需要重新获取数据对象然后一条条删除
		function recursionDel(row){
			var rows=$('#dgItemDown').datagrid('getRows')
			for ( var i = 0; i < rows.length; i++) {
				if(row.typeid==rows[i].typeid){
					var del_index=$('#dgItemDown').datagrid('getRowIndex',rows[i])
					$('#dgItemDown').datagrid('cancelEdit', del_index).datagrid('deleteRow', del_index);
					editIndexDown = undefined;
					return recursionDel(row);
				}
			}
			
		}
		
		function moneyCount(){
			
			var dataList=$('#dgItem').datagrid('getRows');
			var total=0;
			for ( var i = 0; i < dataList.length; i++) {
				sum=dataList[i].price*dataList[i].quantity;
				updateGridData(i,sum)
				total=total+sum
			}
			$('#totalAmt').textbox('setValue',total);
			loadData();
		}
		function updateGridData(index,sum){
			$('#dgItem').datagrid('updateRow',{
				index: index,
				row: {
					totalAmt: sum
				}
			});

		}
		function rowResize(sizeType){
			var baseHeight = 150;
			var newpageSize = sizeType *10; 
			
			  $("#dg").datagrid('resize', {
				   height : baseHeight + (250 * sizeType)
				  });
			  $('#dg').datagrid({ 
  				"pageSize":newpageSize 
  				}); 
		}
		
</script>